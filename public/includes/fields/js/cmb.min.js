window.CMB=function(e,t,n,r){"use strict";var i=e.cmb_l10;var s=e.setTimeout;var o={formfield:"",idNumber:false,file_frames:{},repeatEls:'input:not([type="button"]),select,textarea,.cmb_media_status'};o.metabox=function(){if(o.$metabox){return o.$metabox}o.$metabox=n("table.cmb_metabox");return o.$metabox};o.init=function(){var t=o.metabox();var r=t.find(".repeatable-group");if(i.new_admin_style){t.find(".cmb-spinner img").hide()}o.initPickers(t.find("input:text.cmb_timepicker"),t.find("input:text.cmb_datepicker"),t.find("input:text.cmb_colorpicker"));n("#ui-datepicker-div").wrap('<div class="cmb_element" />');n('<p><span class="button cmb-multicheck-toggle">'+i.check_toggle+"</span></p>").insertBefore("ul.cmb_checkbox_list");t.on("change",".cmb_upload_file",function(){o.formfield=n(this).attr("id");n("#"+o.formfield+"_id").val("")}).on("click",".cmb-multicheck-toggle",o.toggleCheckBoxes).on("click",".cmb_upload_button",o.handleMedia).on("click",".cmb_remove_file_button",o.handleRemoveMedia).on("click",".add-group-row",o.addGroupRow).on("click",".add-row-button",o.addAjaxRow).on("click",".remove-group-row",o.removeGroupRow).on("click",".remove-row-button",o.removeAjaxRow).on("keyup paste focusout",".cmb_oembed",o.maybeOembed).on("cmb_remove_row",".repeatable-group",o.resetTitlesAndIterator);if(r.length){r.filter(".sortable").each(function(){n(this).find(".remove-group-row").before('<a class="shift-rows move-up alignleft" href="#">'+i.up_arrow+'</a> <a class="shift-rows move-down alignleft" href="#">'+i.down_arrow+"</a>")}).on("click",".shift-rows",o.shiftRows).on("cmb_add_row",o.emptyValue)}s(o.resizeoEmbeds,500);n(e).on("resize",o.resizeoEmbeds)};o.resetTitlesAndIterator=function(){n(".repeatable-group").each(function(){var e=n(this);e.find(".repeatable-grouping").each(function(t){var r=n(this);r.data("iterator",t);r.find(".cmb-group-title h4").text(e.find(".add-group-row").data("grouptitle").replace("{#}",t+1))})})};o.toggleCheckBoxes=function(e){e.preventDefault();var t=n(this);var r=t.parents("td").find("input[type=checkbox]");if(t.data("checked")){r.prop("checked",false);t.data("checked",false)}else{r.prop("checked",true);t.data("checked",true)}};o.handleMedia=function(e){if(!wp){return}e.preventDefault();var t=o.metabox();var r=n(this);o.formfield=r.prev("input").attr("id");var s=n("#"+o.formfield);var u=s.attr("name");var a=true;var f=true;var l=r.hasClass("cmb_upload_list");if(o.formfield in o.file_frames){o.file_frames[o.formfield].open();return}o.file_frames[o.formfield]=wp.media.frames.file_frame=wp.media({title:t.find("label[for="+o.formfield+"]").text(),button:{text:i.upload_file},multiple:l?true:false});var c={list:function(e){f=e.toJSON();s.val(f.url);n("#"+o.formfield+"_id").val(f.id);var t=[];n(f).each(function(){if(this.type&&this.type==="image"){a='<li class="img_status">'+'<img width="50" height="50" src="'+this.url+'" class="attachment-50x50" alt="'+this.filename+'">'+'<p><a href="#" class="cmb_remove_file_button" rel="'+o.formfield+"["+this.id+']">'+i.remove_image+"</a></p>"+'<input type="hidden" id="filelist-'+this.id+'" name="'+u+"["+this.id+']" value="'+this.url+'">'+"</li>"}else{a="<li>"+i.file+" <strong>"+this.filename+'</strong>&nbsp;&nbsp;&nbsp; (<a href="'+this.url+'" target="_blank" rel="external">'+i.download+'</a> / <a href="#" class="cmb_remove_file_button" rel="'+o.formfield+"["+this.id+']">'+i.remove_file+"</a>)"+'<input type="hidden" id="filelist-'+this.id+'" name="'+u+"["+this.id+']" value="'+this.url+'">'+"</li>"}t.push(a)});n(t).each(function(){s.siblings(".cmb_media_status").slideDown().append(this)})},single:function(e){f=e.first().toJSON();s.val(f.url);n("#"+o.formfield+"_id").val(f.id);if(f.type&&f.type==="image"){a='<div class="img_status"><img style="max-width: 350px; width: 100%; height: auto;" src="'+f.url+'" alt="'+f.filename+'" title="'+f.filename+'" /><p><a href="#" class="cmb_remove_file_button" rel="'+o.formfield+'">'+i.remove_image+"</a></p></div>"}else{a=i.file+" <strong>"+f.filename+'</strong>&nbsp;&nbsp;&nbsp; (<a href="'+f.url+'" target="_blank" rel="external">'+i.download+'</a> / <a href="#" class="cmb_remove_file_button" rel="'+o.formfield+'">'+i.remove_file+"</a>)"}s.siblings(".cmb_media_status").slideDown().html(a)}};o.file_frames[o.formfield].on("select",function(){var e=o.file_frames[o.formfield].state().get("selection");var t=l?"list":"single";c[t](e)});o.file_frames[o.formfield].open()};o.handleRemoveMedia=function(e){e.preventDefault();var t=n(this);if(t.is(".attach_list .cmb_remove_file_button")){t.parents("li").remove();return false}o.formfield=t.attr("rel");var r=t.parents(".img_status");o.metabox().find("input#"+o.formfield).val("");o.metabox().find("input#"+o.formfield+"_id").val("");if(!r.length){t.parents(".cmb_media_status").html("")}else{r.html("")}return false};n.fn.replaceText=function(e,t,r){return this.each(function(){var i=this.firstChild,s,o,u=[];if(i){do{if(i.nodeType===3){s=i.nodeValue;o=s.replace(e,t);if(o!==s){if(!r&&/</.test(o)){n(i).before(o);u.push(i)}else{i.nodeValue=o}}}}while(i=i.nextSibling)}if(u.length){n(u).remove()}})};n.fn.cleanRow=function(e,t){var r=n(this);var i=r.find('input:not([type="button"]), select, textarea, label');if(t){r.find(".cmb-repeat-table .repeat-row:not(:first-child)").remove()}o.$focus=false;o.neweditor_id=[];i.filter(":checked").removeAttr("checked");i.filter(":selected").removeAttr("selected");if(r.find(".cmb-group-title").length>0){r.find(".cmb-group-title h4").text(r.data("title").replace("{#}",o.idNumber+1))}i.each(function(){var t=n(this);var r=t.hasClass("wp-editor-area");var i=t.attr("for");var s={};var u,a;if(i){s={"for":i.replace("_"+e,"_"+o.idNumber)}}else{var f=t.attr("name");var l=f?f.replace("["+e+"]","["+o.idNumber+"]"):"";a=t.attr("id");u=a?a.replace("_"+e,"_"+o.idNumber):"";s={id:u,name:l,"data-iterator":o.idNumber}}t.removeClass("hasDatepicker").attr(s).val("");if(r){u=u?a.replace("zx"+e,"zx"+o.idNumber):"";t.html("");var c=t.parents(".cmb-type-wysiwyg");c.find(".mce-tinymce:not(:first-child)").remove();var h=c.html().replace(new RegExp(a,"g"),u);c.html(h);o.neweditor_id.push({id:u,old:a})}o.$focus=o.$focus?o.$focus:t});return this};n.fn.newRowHousekeeping=function(){var e=n(this);var t=e.find(".wp-picker-container");var r=e.find(".cmb_media_status");if(t.length){t.each(function(){var e=n(this).parent();e.html(e.find("input:text.cmb_colorpicker").attr("style",""))})}if(r.length){r.empty()}return this};o.afterRowInsert=function(e){if(o.$focus){o.$focus.focus()}var t;if(o.neweditor_id.length){var n;for(n=o.neweditor_id.length-1;n>=0;n--){var r=o.neweditor_id[n].id;var i=o.neweditor_id[n].old;if(typeof tinyMCEPreInit.mceInit[r]==="undefined"){var s=jQuery.extend({},tinyMCEPreInit.mceInit[i]);for(t in s){if("string"===typeof s[t]){s[t]=s[t].replace(new RegExp(i,"g"),r)}}tinyMCEPreInit.mceInit[r]=s}if(typeof tinyMCEPreInit.qtInit[r]==="undefined"){var u=jQuery.extend({},tinyMCEPreInit.qtInit[i]);for(t in u){if("string"===typeof u[t]){u[t]=u[t].replace(new RegExp(i,"g"),r)}}tinyMCEPreInit.qtInit[r]=u}tinyMCE.init({id:tinyMCEPreInit.mceInit[r]})}}o.initPickers(e.find("input:text.cmb_timepicker"),e.find("input:text.cmb_datepicker"),e.find("input:text.cmb_colorpicker"))};o.updateNameAttr=function(){var e=n(this);var t=e.attr("name");if(typeof t==="undefined"){return false}var r=parseInt(e.parents(".repeatable-grouping").data("iterator"));var i=r-1;var s=t.replace("["+r+"]","["+i+"]");e.attr("name",s)};o.emptyValue=function(e,t){n('input:not([type="button"]), textarea',t).val("")};o.addGroupRow=function(e){e.preventDefault();var t=n(this);var r=n("#"+t.data("selector"));var i=r.find(".repeatable-grouping").last();var s=parseInt(i.data("iterator"));o.idNumber=s+1;var u=i.clone();u.data("title",t.data("grouptitle")).newRowHousekeeping().cleanRow(s,true);var a=n('<tr class="repeatable-grouping" data-iterator="'+o.idNumber+'">'+u.html()+"</tr>");i.after(a);o.afterRowInsert(a);if(r.find(".repeatable-grouping").length<=1){r.find(".remove-group-row").prop("disabled",true)}else{r.find(".remove-group-row").removeAttr("disabled")}r.trigger("cmb_add_row",a)};o.addAjaxRow=function(e){e.preventDefault();var t=n(this);var r="#"+t.data("selector");var i=n(r);var s=i.find(".empty-row");var u=parseInt(s.find("[data-iterator]").data("iterator"));o.idNumber=u+1;var a=s.clone();a.newRowHousekeeping().cleanRow(u);s.removeClass("empty-row").addClass("repeat-row");s.after(a);o.afterRowInsert(a);i.trigger("cmb_add_row",a)};o.removeGroupRow=function(e){e.preventDefault();var t=n(this);var r=n("#"+t.data("selector"));var i=t.parents(".repeatable-grouping");var s=r.find(".repeatable-grouping").length;i.nextAll(".repeatable-grouping").find(o.repeatEls).each(o.updateNameAttr);if(s>1){i.remove();if(s<3){r.find(".remove-group-row").prop("disabled",true)}else{r.find(".remove-group-row").prop("disabled",false)}r.trigger("cmb_remove_row")}};o.removeAjaxRow=function(e){e.preventDefault();var t=n(this);var r=t.parents("tr");var i=t.parents(".cmb-repeat-table");if(i.find("tr").length>1){if(r.hasClass("empty-row")){r.prev().addClass("empty-row").removeClass("repeat-row")}t.parents(".cmb-repeat-table tr").remove();i.trigger("cmb_remove_row")}};o.shiftRows=function(e){e.preventDefault();var t=n(this);var r=t.parents(".repeatable-grouping");var i=t.hasClass("move-up")?r.prev(".repeatable-grouping"):r.next(".repeatable-grouping");if(!i.length){return}var s=[];r.find(o.repeatEls).each(function(){var e=n(this);var t;if(e.hasClass("cmb_media_status")){t=e.html()}else if("checkbox"===e.attr("type")){t=e.is(":checked");o.log("checked",t)}else if("select"===e.prop("tagName")){t=e.is(":selected");o.log("checked",t)}else{t=e.val()}s.push({val:t,$:e})});i.find(o.repeatEls).each(function(e){var t=n(this);var r;if(t.hasClass("cmb_media_status")){r=t.html();t.html(s[e]["val"]);s[e]["$"].html(r)}else if("checkbox"===t.attr("type")){s[e]["$"].prop("checked",t.is(":checked"));t.prop("checked",s[e]["val"])}else if("select"===t.prop("tagName")){s[e]["$"].prop("selected",t.is(":selected"));t.prop("selected",s[e]["val"])}else{s[e]["$"].val(t.val());t.val(s[e]["val"])}})};o.initPickers=function(e,t,n){o.initTimePickers(e);o.initDatePickers(t);o.initColorPickers(n)};o.initTimePickers=function(e){if(!e.length){return}e.timePicker({startTime:"00:00",endTime:"23:59",show24Hours:false,separator:":",step:30})};o.initDatePickers=function(e){if(!e.length){return}e.datepicker("destroy");e.datepicker()};o.initColorPickers=function(e){if(!e.length){return}if(typeof jQuery.wp==="object"&&typeof jQuery.wp.wpColorPicker==="function"){e.wpColorPicker()}else{e.each(function(e){n(this).after('<div id="picker-'+e+'" style="z-index: 1000; background: #EEE; border: 1px solid #CCC; position: absolute; display: block;"></div>');n("#picker-"+e).hide().farbtastic(n(this))}).focus(function(){n(this).next().show()}).blur(function(){n(this).next().hide()})}};o.maybeOembed=function(e){var t=n(this);var r=e.type;var i={focusout:function(){s(function(){o.spinner(".postbox table.cmb_metabox",true)},2e3)},keyup:function(){var n=function(t,n){return e.which<=n&&e.which>=t};if(n(48,90)||n(96,111)||n(8,9)||e.which===187||e.which===190){o.doAjax(t,e)}},paste:function(){s(function(){o.doAjax(t)},100)}};i[r]()};o.resizeoEmbeds=function(){o.metabox().each(function(){var e=n(this);var t=e.parents(".inside");if(!t.length){return true}var r=Math.round(t.width()*.82*.97)-30;if(r>639){return true}var i=e.find(".cmb-type-oembed .embed_status");var s=i.children().not(".cmb_remove_wrapper");if(!s.length){return true}s.each(function(){var e=n(this);var t=e.width();var i=e.height();var s=r;if(e.parents(".repeat-row").length){s=r-91}var o=Math.round(s*i/t);e.width(s).height(o)})})};o.log=function(){if(i.script_debug&&console&&typeof console.log==="function"){console.log.apply(console,arguments)}};o.spinner=function(e,t){if(t){n(".cmb-spinner",e).hide()}else{n(".cmb-spinner",e).show()}};o.doAjax=function(e){var t=e.val();if(t.length<6){return}var r=e.attr("id");var u=e.parents(".cmb-repeat-table  tr td");u=u.length?u:e.parents(".cmb_metabox tr td");var a=n(".embed_status",u);var f=e.width();var l=n(":first-child",a);o.log("oembed_url",t,r);f=a.length&&l.length?l.width():e.width();o.spinner(u);n(".embed_wrap",u).html("");s(function(){if(n(".cmb_oembed:focus").val()!==t){return}n.ajax({type:"post",dataType:"json",url:i.ajaxurl,data:{action:"cmb_oembed_handler",oembed_url:t,oembed_width:f>300?f:300,field_id:r,object_id:e.data("objectid"),object_type:e.data("objecttype"),cmb_ajax_nonce:i.ajax_nonce},success:function(e){o.log(e);if(typeof e.id==="undefined"){return}o.spinner(u,true);n(".embed_wrap",u).html(e.result)}})},500)};n(t).ready(o.init);return o}(window,document,jQuery)